# çµæ¢ App åç«¯ç³»ç»Ÿæ¶æ„ä¸å¿«é€Ÿå‚è€ƒ

## ğŸ“‹ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ index.ts                           # ä¸»åº”ç”¨ï¼Œè·¯ç”±é›†æˆ
â”œâ”€â”€ schema.ts                          # Drizzle ORM Schema å®šä¹‰
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ index.ts                       # è®¤è¯æ¨¡å— (ç™»å½•æ³¨å†Œã€phoneç»‘å®š)
â”œâ”€â”€ member/
â”‚   â”œâ”€â”€ quota.ts                       # é…é¢å¼•æ“ (ä¼šå‘˜åˆ¤å®šã€é…é¢æ‰£å‡ã€çµçŸ³å…‘æ¢)
â”‚   â””â”€â”€ referral.ts                    # åˆ†äº«å¥–åŠ± (åŒå‘å¥–åŠ±é—­ç¯)
â”œâ”€â”€ divination/
â”‚   â””â”€â”€ quota-check.ts                 # æ’å¦ä¸šåŠ¡ (å»é‡ã€é…é¢æ£€æŸ¥ã€å†å²æŸ¥è¯¢)
â””â”€â”€ utils/
    â”œâ”€â”€ types.ts                       # TypeScript ç±»å‹å®šä¹‰
    â””â”€â”€ response.ts                    # å“åº”å·¥å…·ä¸æ—¶é—´å¤„ç†

drizzle/
â”œâ”€â”€ 0000_moaning_susan_delgado.sql     # åˆå§‹è¿ç§»
â””â”€â”€ 0001_extended_schema.sql           # Schema æ‰©å±•è¿ç§»
```

---

## ğŸ”Œ API å¿«é€Ÿå¯¼èˆª

### è®¤è¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| POST | `/auth/login` | ç™»å½•å³æ³¨å†Œï¼ˆusername+password+phoneï¼‰ | âŒ |
| POST | `/auth/bind-phone` | ç»‘å®šæ‰‹æœºå·ï¼ˆè§¦å‘åˆ†äº«é—­ç¯ï¼‰ | âœ… |

### ä¼šå‘˜ä¸é…é¢æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| POST | `/api/member/exchange` | çµçŸ³å…‘æ¢ä¼šå‘˜ (type: weekly\|monthly) | âœ… |
| GET | `/api/member/status` | æŸ¥è¯¢ä¼šå‘˜ä¸é…é¢çŠ¶æ€ | âœ… |

### åˆ†äº«æ¨èæ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/api/referral/rewards` | æŸ¥è¯¢æ¨èå¥–åŠ±å†å² | âœ… |

### æ’å¦ä¸šåŠ¡æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| POST | `/api/divination/check-quota` | æ’å¦å‰é…é¢æ£€æŸ¥ (å«å»é‡) | âœ… |
| POST | `/api/divination/divine` | æ‰§è¡Œæ’å¦ï¼ˆæ¶ˆè€—é…é¢ï¼‰ | âœ… |
| GET | `/api/divination/history` | æŸ¥è¯¢æ’å¦å†å² | âœ… |

---

## ğŸ” æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 1ï¸âƒ£ ç™»å½•ä¸æ³¨å†Œï¼ˆç™»å½•å³æ³¨å†Œï¼‰

**æµç¨‹ï¼š**

```
ç”¨æˆ·è¾“å…¥ username + password + phone + å¯é€‰(referrerId, deviceId)
  â†“
æ£€æŸ¥ username æ˜¯å¦å­˜åœ¨ï¼Ÿ
  â”œâ”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·
  â”‚  â”œâ”€ dailyFreeQuota = 1
  â”‚  â”œâ”€ bonusQuota = 2ï¼ˆé¦–æ—¥èµ é€ï¼‰
  â”‚  â”œâ”€ lingshi = 0
  â”‚  â””â”€ memberLevel = 0
  â”‚
  â””â”€ å­˜åœ¨ â†’ éªŒè¯ password + phone æ˜¯å¦åŒ¹é…
     â””â”€ åŒ¹é… â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯

ç­¾å‘ JWT Tokenï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
```

### 2ï¸âƒ£ é…é¢ç®¡ç†ï¼ˆä¼˜å…ˆçº§é¡ºåºï¼‰

**æ’å¦å‰æ£€æŸ¥ä¼˜å…ˆçº§ï¼š**

1. **ä¼šå‘˜å…è´¹** â†’ è‹¥ memberLevel=1 ä¸” memberExpireAt > nowï¼Œæ— éœ€æ‰£è´¹ï¼Œç›´æ¥æ”¾è¡Œ
2. **æ¯æ—¥å…è´¹é…é¢** â†’ è‹¥ lastUsedDate != ä»Šå¤©ï¼Œé‡ç½® dailyFreeQuota=1ï¼›è‹¥ >0ï¼Œå¯ç”¨
3. **èµ é€é…é¢** â†’ è‹¥ bonusQuota > 0ï¼Œå¯ç”¨ï¼›æ‰£å‡æ—¶ä½¿ç”¨ WHERE bonusQuota > 0 é˜²æ­¢è´Ÿæ•°
4. **çµçŸ³æ‰£å‡**ï¼ˆé…é¢å…¨éƒ¨ç”¨å°½æ—¶ï¼‰
   - 4.1 ä¼˜å…ˆæ‰£å‡ã€Œå…è´¹æ¬¡æ•°å¯¹åº”çš„çµçŸ³ã€ï¼ˆ100 çµçŸ³/æ¬¡ï¼‰
   - 4.2 å†æ‰£å‡ã€Œèµ é€é…é¢å¯¹åº”çš„çµçŸ³ã€ï¼ˆ100 çµçŸ³/æ¬¡ï¼‰
   - è‹¥çµçŸ³éƒ½ä¸è¶³ï¼Œæç¤ºç”¨æˆ·éœ€è¦å……å€¼

**çµçŸ³å…‘æ¢ä¸æ¶ˆè€—ä»·æ ¼ï¼š**

```
æ’å¦æ¶ˆè€—ï¼š
  - å…è´¹æ¬¡æ•°çµçŸ³æˆæœ¬ï¼š100 çµçŸ³/æ¬¡
  - èµ é€é…é¢çµçŸ³æˆæœ¬ï¼š100 çµçŸ³/æ¬¡

ä¼šå‘˜å…‘æ¢ï¼š
  - 700 çµçŸ³  = 7 å¤©å‘¨ä¼šå‘˜
  - 3000 çµçŸ³ = 30 å¤©æœˆä¼šå‘˜
  - 100 çµçŸ³  = 1 æ¬¡æ’å¦åˆ¸
```

**ä¼šå‘˜æœ‰æ•ˆæœŸå †å é€»è¾‘ï¼š**

```javascript
newExpireAt = max(now, currentMemberExpireAt) + daysToAdd
// ç¡®ä¿é‡å¤å…‘æ¢æ—¶æœ‰æ•ˆæœŸé¡ºå»¶è€Œéè¦†ç›–
```

### 3ï¸âƒ£ åˆ†äº«å¥–åŠ±é—­ç¯

**è§¦å‘æ¡ä»¶ï¼š** æ–°ç”¨æˆ·åŒæ—¶å®Œæˆ

- âœ… username æ³¨å†Œ
- âœ… phone ç»‘å®š

**åŒå‘å¥–åŠ±ï¼š**

```
æ–°ç”¨æˆ·å¥–åŠ±ï¼š
  â””â”€ å·²åœ¨æ³¨å†Œæ—¶è·å¾— 3 æ¬¡ä½“éªŒï¼ˆ1 dailyFreeQuota + 2 bonusQuotaï¼‰

è€ç”¨æˆ·ï¼ˆæ¨èäººï¼‰å¥–åŠ±ï¼š
  â”œâ”€ 100 çµçŸ³ï¼ˆæ— ä¸Šé™ï¼‰
  â””â”€ bonus_quota +1ï¼ˆä¸Šé™5ï¼Œè¾¾åˆ°ä¸Šé™åä»…å¢åŠ çµçŸ³ï¼‰
```

### 4ï¸âƒ£ æ’å¦å»é‡ä¸é…é¢æ‰£å‡

**5 åˆ†é’Ÿå»é‡å“ˆå¸Œï¼š**

```
SHA256(userId + subject + category)
// åŒä¸€ç”¨æˆ·ï¼ŒåŒä¸€äº‹ç”±ï¼ŒåŒä¸€ç±»åˆ«ï¼Œ5åˆ†é’Ÿå†…ä¸é‡å¤æ‰£è´¹
```

**é…é¢æ£€æŸ¥é¡ºåºï¼š**

```
POST /api/divination/check-quota
  â†“
è®¡ç®— subjectHash
  â†“
æ£€æŸ¥ 5 åˆ†é’Ÿå†…æ˜¯å¦æœ‰ç›¸åŒ hash çš„è®°å½•ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ isDuplicate=trueï¼Œä¸å¯æ’å¦
  â””â”€ å¦ â†’ æ£€æŸ¥é…é¢çŠ¶æ€
         â”œâ”€ ä¼šå‘˜çŠ¶æ€ï¼Ÿâ†’ canDivine=true
         â”œâ”€ å…è´¹æ¬¡æ•°ï¼Ÿâ†’ canDivine=true
         â”œâ”€ èµ é€æ¬¡æ•°ï¼Ÿâ†’ canDivine=true
         â”œâ”€ çµçŸ³è¶³å¤Ÿå…‘æ¢å…è´¹æ¬¡æ•°ï¼Ÿâ†’ canDivine=trueï¼ˆ100çµçŸ³ï¼‰
         â”œâ”€ çµçŸ³è¶³å¤Ÿå…‘æ¢èµ é€é…é¢ï¼Ÿâ†’ canDivine=trueï¼ˆ100çµçŸ³ï¼‰
         â””â”€ éƒ½æ²¡æœ‰ï¼Ÿâ†’ canDivine=falseï¼ˆæç¤ºéœ€è¦çµçŸ³ï¼‰
```

---

## ğŸ—‚ï¸ æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨

```typescript
{
  id: integer (PK),
  username: text (UNIQUE),                 // ç™»å½•è´¦å·
  phone: text (UNIQUE),                    // æ‰‹æœºå·
  password: text,                          // åŠ å¯†å¯†ç 
  dailyFreeQuota: integer (é»˜è®¤1),         // æ¯æ—¥å…è´¹æ¬¡æ•°
  bonusQuota: integer (é»˜è®¤0),             // èµ é€æ¬¡æ•°ï¼Œä¸Šé™5
  lastUsedDate: integer (é»˜è®¤0),           // ä¸Šæ¬¡ä½¿ç”¨æ—¥æœŸ YYYYMMDD
  lingshi: integer (é»˜è®¤0),                // çµçŸ³ä½™é¢
  memberLevel: integer (é»˜è®¤0),            // 0=éä¼šå‘˜, 1=ä¼šå‘˜
  memberExpireAt: integer (é»˜è®¤0),         // ä¼šå‘˜è¿‡æœŸæ—¶é—´æˆ³
  referrerId: integer (FK),                // æ¨èäººID
  deviceId: text,                          // è®¾å¤‡æŒ‡çº¹ï¼ˆé£æ§ï¼‰
  createdAt: integer,                      // åˆ›å»ºæ—¶é—´æˆ³
  updatedAt: integer,                      // æ›´æ–°æ—¶é—´æˆ³
}
```

### divinationRecords è¡¨

```typescript
{
  id: integer (PK),
  userId: integer (FK),                    // ç”¨æˆ·ID
  subjectHash: text (INDEX),               // SHA256 å»é‡å“ˆå¸Œ
  inputData: text,                         // è„±æ•çš„èµ·å¦å‚æ•° (JSON)
  lastUsedAt: integer,                     // æœ€åä½¿ç”¨æ—¶é—´æˆ³
  createdAt: integer,                      // è®°å½•åˆ›å»ºæ—¶é—´æˆ³
}
```

### referralRewards è¡¨

```typescript
{
  id: integer (PK),
  referrerId: integer (FK),                // æ¨èäººID
  inviteeId: integer (FK),                 // è¢«æ¨èäººID
  rewardType: text,                        // 'lingshi' | 'bonus_quota'
  lingshiAwarded: integer (é»˜è®¤0),         // çµçŸ³å¥–åŠ±æ•°é‡
  bonusQuotaAwarded: integer (é»˜è®¤0),      // é…é¢å¥–åŠ±æ•°é‡
  createdAt: integer,                      // å¥–åŠ±æ—¶é—´æˆ³
}
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### å¹¶å‘å®‰å…¨æ€§

```typescript
// âœ… é˜²æ­¢è´Ÿå€¼æ‰£å‡
UPDATE users
SET bonus_quota = bonus_quota - 1
WHERE id = ? AND bonus_quota > 0  // å…³é”®æ¡ä»¶

// âœ… ä¼šå‘˜æœ‰æ•ˆæœŸå †å 
const newExpireAt = Math.max(now, user.memberExpireAt) + daysToAdd;
```

### æ—¶é—´å¤„ç†

```typescript
// ç»Ÿä¸€ä½¿ç”¨ UTC+8ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
function getTodayDate(): number {
  // è¿”å› YYYYMMDD æ ¼å¼çš„æ•°å­—ï¼Œå¦‚ 20260204
  const utc8 = new Date(now.getTime() + 8 * 60 * 60 * 1000);
  return parseInt(`${year}${month}${date}`);
}
```

### éšæ•å¤„ç†

```typescript
// æ‰‹æœºå·éšæ•ï¼š189****1234
maskPhone("18900001234") â†’ "189****1234"
```

---

## ğŸ“Š å“åº”æ ¼å¼ç»Ÿä¸€

### æˆåŠŸå“åº” (200)

```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": { /* ä¸šåŠ¡æ•°æ® */ }
}
```

### é”™è¯¯å“åº”

```json
{
  "code": 400 | 401 | 403 | 500,
  "message": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

---

## ğŸ§ª å¸¸è§æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šå®Œæ•´æ–°ç”¨æˆ·æµç¨‹

```bash
1. POST /auth/login (username + password + phone)
   â†“ è·å¾— token
2. GET /api/member/status
   â†“ æŸ¥çœ‹åˆå§‹é…é¢ (1 dailyFreeQuota + 2 bonusQuota)
3. POST /api/divination/divine
   â†“ æ’å¦å¹¶æ‰£å‡ 1 æ¬¡é…é¢
4. GET /api/member/status
   â†“ é…é¢å˜ä¸º (0 dailyFreeQuota + 2 bonusQuota)
```

### åœºæ™¯ 2ï¼šæ¨èå¥–åŠ±é—­ç¯

```bash
1. æ¨èäººåˆ›å»ºè´¦æˆ· â†’ è®°å½• ID (å¦‚ 5)
2. æ–°ç”¨æˆ·ç™»å½•å¹¶æºå¸¦ referrerId=5
3. æ–°ç”¨æˆ·æ‰§è¡Œ POST /auth/bind-phone
   â†“ è‡ªåŠ¨è§¦å‘åˆ†äº«é—­ç¯
4. æ¨èäººæŸ¥è¯¢ GET /api/referral/rewards
   â†“ æ˜¾ç¤º +100 çµçŸ³ + 1 bonus_quota
```

### åœºæ™¯ 3ï¼šçµçŸ³å…‘æ¢ä¼šå‘˜

```bash
1. ç”¨æˆ·æ‹¥æœ‰ 700+ çµçŸ³
2. POST /api/member/exchange (type: weekly)
   â†“ æ‰£å‡ 700 çµçŸ³ï¼ŒmemberExpireAt é¡ºå»¶ 7 å¤©
3. åœ¨ä¼šå‘˜æœ‰æ•ˆæœŸå†…æ’å¦æ— éœ€æ‰£è´¹
```

### åœºæ™¯ 4ï¼š5åˆ†é’Ÿå»é‡

```bash
1. POST /api/divination/divine (subject: "è´¢è¿", category: "è´¢è¿")
   â†“ æˆåŠŸæ’å¦ï¼Œè®°å½• hash
2. ç«‹å³å†è¯·æ±‚ç›¸åŒå†…å®¹
   â†“ isDuplicate=trueï¼Œä¸æ‰£è´¹ï¼Œè¿”å›é”™è¯¯
3. ç­‰å¾… 5 åˆ†é’Ÿåé‡è¯•
   â†“ æˆåŠŸæ’å¦
```

---

## ğŸš€ æœ¬åœ°å¼€å‘ä¸éƒ¨ç½²

### æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
# â†’ http://localhost:8787

# åº”ç”¨è¿ç§»
npx drizzle-kit push:sqlite

# æŸ¥çœ‹æ•°æ®åº“
npx drizzle-kit studio
```

### ç”Ÿäº§éƒ¨ç½² (Cloudflare Workers)

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆwrangler.tomlï¼‰
JWT_SECRET = "å¼ºéšæœºå¯†é’¥"

# éƒ¨ç½²
npm run deploy
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ–°ç”¨æˆ·æœ‰ 2 æ¬¡ bonusQuotaï¼Ÿ

A: æ–°ç”¨æˆ·é¦–æ—¥ä½“éªŒç­–ç•¥ â†’ 1 dailyFreeQuota + 2 bonusQuota = 3 æ¬¡ï¼Œæé«˜ç”¨æˆ·é¦–æ—¥ä½“éªŒã€‚

### Q2: ä¼šå‘˜è¿‡æœŸåï¼Œé…é¢å¦‚ä½•é‡ç½®ï¼Ÿ

A: ä¼šå‘˜è¿‡æœŸåï¼Œä¸‹ä¸€æ¬¡æ’å¦æ—¶æ£€æŸ¥ memberExpireAtï¼Œå‘ç°å·²è¿‡æœŸåˆ™æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥å…è´¹é…é¢ã€‚

### Q3: åŒä¸€ç”¨æˆ·ï¼Œä¸åŒäº‹ç”±ï¼Œ5åˆ†é’Ÿå†…æ˜¯å¦ä¼šå»é‡ï¼Ÿ

A: **ä¸ä¼š**ã€‚Hash åŒ…å«äº† subject å’Œ categoryï¼Œä¸åŒçš„é—®é¢˜æœ‰ä¸åŒçš„ hashï¼Œä¸ä¼šè¢«è§†ä¸ºé‡å¤ã€‚

### Q4: bonusQuota è¶…è¿‡ 5 ä¸Šé™åæ€ä¹ˆåŠï¼Ÿ

A: è¾¾åˆ°ä¸Šé™ï¼ˆ5ï¼‰åï¼Œæ–°åˆ†äº«æˆåŠŸä¸å†å¢åŠ  bonusQuotaï¼Œä»…å¢åŠ  100 çµçŸ³ã€‚

### Q5: ç”¨æˆ·å¯ä»¥ä¸€æ¬¡å…‘æ¢å¤šä¸ªä¼šå‘˜å—ï¼Ÿ

A: å¯ä»¥ã€‚æ¯æ¬¡å…‘æ¢æ—¶ï¼Œæ–°æœ‰æ•ˆæœŸ = max(now, å½“å‰æœ‰æ•ˆæœŸ) + å…‘æ¢å¤©æ•°ï¼Œå®ç°å †å ã€‚

---

## ğŸ“ æŠ€æœ¯æ ˆ

- **æ¡†æ¶ï¼š** Hono.js (Cloudflare Workers)
- **æ•°æ®åº“ï¼š** SQLite via D1
- **ORMï¼š** Drizzle ORM
- **è®¤è¯ï¼š** JWT (HS256)
- **åŠ å¯†ï¼š** bcryptjs
- **æ—¶é—´å¤„ç†ï¼š** UTC+8 (åŒ—äº¬æ—¶é—´)

---

## ğŸ“ ç‰ˆæœ¬è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | æè¿° |
|------|------|------|
| 1.0.0 | 2026-02-04 | åˆå§‹ç‰ˆæœ¬ï¼šç™»å½•æ³¨å†Œã€é…é¢ç®¡ç†ã€åˆ†äº«å¥–åŠ±ã€æ’å¦å»é‡ |

---

Generated with â¤ï¸ for çµæ¢ App Backend
